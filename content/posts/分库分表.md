---
categories: 数据库
tags:
  - 分库分表
  - 系统架构设计
date: 2024-07-24
title: 数据库分库分表简述
---

## 介绍
是一种应对海量数据处理需求的技术方案，当数据库或表中的数据量过于庞大：
1. IO瓶颈:
	1. 磁盘IO：热点数据太多，数据库缓存不足，产生大量磁盘IO，效率较低。 
	2. 网络IO：请求数据太多，带宽不够，网络IO瓶颈。
2. CPU瓶颈:排序、分组、连接查询、聚合统计等SQL会耗费大量的CPU资源，请求数太多，CPU出现瓶颈。

分库分表的中心思想都是将数据分散存储，使得单一数据库/表的数据量变小来缓解单一数据库的性能问题，从而达到提升数据库性能的目的。

**分库（Database Sharding）：​**将数据分散到不同的数据库中。每个数据库可以在同一台服务器上，也可以分布在不同的服务器上。​
**分表（Table Sharding）：​**将同一个表的数据分散到多个表中。通常这些表会在同一个数据库中，也可以在不同的数据库中。​

![](Screenshot%202024-08-27%20at%2013.46.36.png)
总的来说，分库分表使用的场景不一样： 分表是因为数据量比较大，**导致事务执行缓慢**；分库是**因为单库的性能无法满足要求**。

### 为什么要分库：
主要由于**容量和连接数**两方面的原因：
- 单数据库实例的磁盘容量是固定的，当存储的数据量不断增大，单机容量无法承载的时候，所以最简单的方式就是增加机器的性能，增加单实例磁盘空间，但也总有上限，而且价值昂贵。另一种方式就是采用多库来存储，也就是增加数据库实例，采用分库存储
- ​数据库的连接数是有限的，在高并发场景下，多个业务同时操作一个数据库，很容易将链接耗尽，使后续数据库访问无法正常进行。**所以数据分库存储可以有效解决连接数有限问题**

### 为什么要分表：
数据量太大了而无法保证数据的读写性能。
1. **提高查询性能**：当表的数据量非常大时，查询会变得很慢。分表可以减少每个表中的数据量，从而提高查询速度。​
2. **提升写入性能**：写入操作也会因为数据量大而变慢。分表可以分散写入压力，提高整体写入性能。​
3. **减轻锁竞争**：在高并发场景下，大表容易出现锁竞争，导致性能下降。分表可以减少锁的竞争，提高并发处理能力。​
4. **存储优化**：单个表的数据量过大会导致存储管理上的问题，比如索引维护成本增加，备份和恢复时间变长等。分表有助于优化存储管理。

### 什么时候分库分表

#### 什么时候需要分库​

1. **连接数不够**​：单实例数据库不得不分库的主要原因是连接数不够，所以需要分库的第一种场景就是，数据库连接数不足的时候，就需要考虑分库了，通过增加数据库实例的方式来提供更多的可用数据库链接，从而提升系统的并发度​
2. **微服务场景业务拆分**​：第二种典型的场景就是在微服务场景中，在进行微服务拆分时，我们通常会根据业务边界，将各个业务的数据从单一数据库中拆分出来，这样做其实一方面是业务职责更清晰独立，另一方面也是应证了低一点，是单一库的连接数不至于太多。具体来说，比如在一个电商微服务系统中，将订单、物流、商品、会员等数据分别存储到独立的数据库中。
![](Screenshot%202024-08-27%20at%2014.57.05.png)
#### 什么时候需要分表​
- 分表主要考虑的是数据量大的问题
- 如果单表数据量非常庞大，并发不高且数据库连接数还能应对，但在存储和查询性能方面遇到了瓶颈，即使进行了多种优化仍无法提升效率，那么就需要考虑进行分表处理了。
- 对于单表，参考阿里开发手册，一般建议单表行数超500万行或者单表容量超过2GB，就推荐分库分表。​
​
￼
#### 什么时候需要既分库又分表​
当你需要同时解决并发量大和数据量大的问题时，通常情况下，高并发和数据量大的问题都是同时发生的。因此，我们经常需要同时进行分库和分表。​
具体来说，当数据库连接数已经不足以应对高并发请求，并且单表数据量过大导致查询性能变慢时，就需要考虑同时进行分库和分表。

## 拆分策略

分库分表的形式，主要是两种: **垂直拆分和水平拆分**。
而拆分的粒度，一般又分为**分库和分表**，所以组成的拆分策略最终如下:

![](Screenshot%202024-08-27%20at%2013.48.22.png)

### 垂直拆分

#### 垂直分库

按照**业务和功能**的维度进行垂直切分，将不同业务数据分别放到不同的数据库中，做到专库专用。并且往往将不同的数据库放在不同的服务器上，这样磁盘空间和内存问题都会得到解决

![](Screenshot%202024-08-27%20at%2013.49.50.png)

特点:
- 每个库的表结构都不一样。
- 每个库的数据也不一样。
- **所有库的并集是全量数据。**


#### 垂直分表

垂直分表是**针对业务中字段较多的大表**进行的一种优化策略。

它通常将业务宽表中相对独立的字段或不常用的字段拆分到单独的数据表中，是一种将大表拆分成小表的模式。

拆分后每个小表只包含部分字段，但所有小表通过主键或外键关联

![](Screenshot%202024-08-27%20at%2013.51.11.png)

特点:
- 每个表的结构都不一样。
- 每个表的数据也不一样，一般通过一列(主键/外键)关联。
- **所有表的并集是全量数据。**

### 水平拆分

#### 水平分库
水平分库:以字段为依据，按照一定策略，**将一个库的数据拆分到多个库中。**

每个服务器具有相应的库表，每个库的结构都一样，只是表中的数据集合不同， 以此实现水平扩展，这种方式能够有效缓解单机和单库的性能瓶颈，突破IO，连接数等硬件资源的限制

![](Screenshot%202024-08-27%20at%2013.52.53.png)
特点：
- **每个库的表结构都一样。**
- **每个库的数据都不一样。**
- 所有库的并集是全量数据。

#### 水平分表

水平分表是指在**单个数据库**中，根据一定的规则将一个大的数据表切割成多个具有相同结构的小表，每个小表仅存储原始表数据的一部分。

往往应对的是单表数据过大而导致的查询或写入慢等问题，**但是因为这些表还是在一个数据库中，所以数据库级别的操作还是有IO瓶颈**

特点:
  每个表的表结构都一样。
  每个表的数据都不一样。
  所有表的并集是全量数据。


## 分片策略

### 范围分片

1. **以时间维度来划分​**
	比如某些数据中心，比如订单中心，可以以月份为维度来划分历史订单，一个月的订单数据存储到一个表中​
2. **按地域维度来划分​**
	比如业务是广域的业务，可以将数据以省或者市的维度来分散存储到不同的数据库或者数据表中​
3. **按大小维度来划分​**
	比如用户表t_user被拆分成t_user_1、t_user_2、t_user_3三张表，后续将user_id范围为1 ~ 1000w的用户数据放入t_user_1，1000~ 2000w放入t_user_2，2000~3000w放入t_user_3

#### 优点

1. 单表数据量可控​
2. 水平扩展简单只需增加节点即可，无需对其他分片的数据进行迁移

#### 缺点

**由于连续分片可能存在数据热点，导致数据倾斜，数据库压力分摊不均匀。**
比如按时间字段分片时，如果某一段时间（双11等大促）订单骤增，存11月数据的表可能会被频繁的读写，其他分片表存储的历史数据则很少被查询，

### hash分片

关键字段取模是一种最为常见的数据路由方式，通过对关键字段进行取模运算（对哈希结果取余数，即hash(XXX) mod N，其中N为数据库实例数或子表数量）

#### 优点

实现简单，数据分布相对比较均匀，不易出现请求都打到一个库上的情况​

#### 缺点

取模算法在集群的伸缩性支持上存在一些问题。例如，假设有 N 个数据库，数据存储位置通过 hash(user_id) % N 计算。
- 如果某一台机器宕机，那么原本应该存储在该数据库的数据将无法访问。为了应对这种情况，宕机的实例会被移出集群。​
- 此时，集群中的机器数量减少，新的算法变为 hash(user_id) % (N-1)。这样一来，同一用户的数据可能会被分配到不同的数据库中。
- 等到宕机的机器恢复后，再次用 user_id 作为条件查询时，用户的数据会出现丢失或不完整的情况。​

改进方式：可以使用一致性哈希（Consistent Hashing）算法。与简单取模不同，一致性哈希能够更好地处理节点的增加和减少，减少数据的重新分配量，从而更有效地支持集群的动态伸缩

### 查表分片

查表法分片是指**通过预先构建的映射表**来决定数据的分片位置。
这种方法通过在查询时查找映射表来确定某条数据应该存储在哪个分片上。这种方式没有一种固定的规则，数据落在哪个分片上，全靠人为来分配，分配的结果记录在一张表里面。每次执行查询的时候，先去表里查一下要找的数据在哪个分片中

![](Screenshot%202024-08-27%20at%2015.39.35.png)

#### 优点

1. 主要优点就是**灵活性高**，不局限于某种特定的规则，可以人为的来确定某个key位于哪个分片。所以在前面两种方式都很难达到数据均匀的情况下，可以用这种方式来人工分片。​
2. **易于调整**，当业务需求变化时，可以通过更新映射表来调整分片策略，而不需要对已有数据进行大规模迁移。

比如发现某个分片已经是热点了，可以直接把这个分片再拆成几个分片，或者把这个分片的数据移到其他分片中去，然后修改一下分片映射表，就可以在线完成数据拆分了​

#### 缺点

1. 查表分片的主要缺点是对数据量有一定的限制，因为所有的数据映射都需要存在一张表中，所以分片映射表本身的数据不能太多，否则这个表反而成为热点和性能瓶颈了​
2. 第二个表明显的缺点就是**每次写入和查询都需要二次查表**，增加了系统的查询和写入延迟，影响整体性能，这种情况下分片映射表可以**通过缓存来加速查询**，实际性能并不会慢很多


### 选择

在真实的业务场景下，选择适合的分片方式：​
- 一方面需要综合考虑业务数据规模、数据特性、查询和写入模式、以及系统扩展性等因素。​
- 另一方面要充分结合各种分片方式的优缺点，看那种方式的优点更适合当下业务场景，同时又能有效规避他的缺点。​

#### 范围算法

**类似这种数据量很大，范围属性很明确或者是查询目标带有范围属性的业务**，比如一些历史数据，适合范围算法来分片​

1. 比如日志系统这种海量的数据，一般用来给开发者定位问题，一般需要查找到某个具体时刻的日志，所以日志系统用范围算法里以时间维度来分片就很合适，
2. 像地理数据天然就带有地理属性，按地理区域分片，如按国家、省份进行分片也非常合适。

#### 查表分片：

**需要灵活调整分片策略以确保负载均衡和高性能**。类似这这业务，**数据量不大，但是分片维度多，而且需要频繁的调整分片策略**的业务一般适合查表分片方案​

1. 多租户的SaaS应用，需要确保每个租户的数据严格隔离，同时支持租户数据的动态迁移和分片调整
2. 以及一些小型的游戏服务器，需要存储玩家数据，玩家的活跃度和地理位置可能会频繁变化，

#### hash分片：

**用户存储数据量非常大，分布相对均匀，就适合用hash分片来存储**
1. 而对于像一些成熟的社交平台，电商平台，CRM系统的用户存储这类数据量非常大，分布相对均匀，就适合用hash分片来存储。

## 分库分表架构模式

### 客户端模式

客户模式（client 模式）是指分库分表的逻辑都在系统应用内部进行控制。
在这种模式下，应用程序负责将拆分后的 SQL 语句直接发送到多个数据库进行操作，然后在本地合并和汇总数据。​
​![](Screenshot%202024-08-27%20at%2015.43.31.png)
从图中可以看出，客户端模式是一种无中心化的架构模式，但是这种方式分片逻辑会侵入我们的业务代码，跟业务代码耦合严重，在java开发中，通常以jar包的形式提供服务，ShardingSphere-JDBC 就是这种模式的典型实现，包括美团的 Zebra、MTDDL，阿里 TDDL 都是基于这种模式的实现​

shardingJDBC:基于AOP原理，在应用程序中对本地执行的SQL进行拦截，解析、改写、路由处理。需要自行编码配置实现，只支持java语言，性能较高。

#### 优点​

客户端模式从架构上它是去中心化的，这样就避免了中间件模式的proxy故障问题，
同时因为没有中间层性能高、灵活可控，而且因为没有proxy层，不需要考虑proxy的高可用和集群，运维成本也比较低；
另外一半引入jar包就可以，所以实现起来也相对简单；
**性能上来说，因为这种模式是直连的数据库，所以性能上也相对较好​**

#### 缺点​

客户端模式主要缺点是对代码有侵入，所以基本只能支持单语言；
并且是先上一般是依赖基础架构团队的Jar包，一旦有版本升级或者Bug修改，所有应用到的项目都要跟着升级，升级上比较麻烦


### 代理模式

代理模式（proxy 模式）将应用程序与 MySQL 数据库隔离开来。在这种模式下，业务应用不需要直接连接数据库，而是连接到代理服务。
代理服务实现了 MySQL 协议，对于业务应用来说，代理服务就像是数据库。代理服务会将 SQL 语句分发到具体的数据库执行，并返回结果。代理服务内部包含分库分表的配置，并根据这些配置自动创建分片表。

![](Screenshot%202024-08-27%20at%2015.45.48.png)

从图中可以看出代理模式是一种中心化的架构模式，这种模式旨在实现透明化的数据库代理端，并独立于应用部署，因为独立部署，**所以对异构语言没有限制，不会对应用造成侵入**。

ShardingSphere-Proxy 就是 DB 代理模式的经典实现，包括阿里的 MyCat、美团的 Meituan Atlas 和百度 Heisenberg 就是基于代理模式的实现​

#### 优点​

代理模式的分片逻辑一般实现为一个独立的进程或者单独的服务，所以可以支持异构语言，
对当前程序没有侵入性，对业务方来说是透明的。
正是因为它对业务方透明，无耦合，所以发布新功能或者修复Bug，只要重新部署代理服务集群即可，在升级上更容易​

#### 缺点​
代理模式缺点也非常明显，由于在数据库和业务代码之间加了一层代理，整个执行链路延长了，应用->代理服务->MySQL，所以性能上会有一些损耗。
另外需要单独搭建一套服务，既然是服务那么就要考虑高可用，有一定的维护成本。
同时因为对关系型数据库增加了代理，**会造成问题难调试​**

### 选择

业务上我们在选择这两种模式的时候，也要结合自身的业务特点和组织架构，扬长避短。规模不大时建议用Client方式的中间件，使用简单，也没什么维护成本。规模大了后建议用Proxy方式的中间件，更方便统一管控和维护。​
​



